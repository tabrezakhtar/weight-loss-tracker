---
---
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<button id="generateLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold transition-all duration-150 flex items-center gap-1 sm:gap-2 cursor-pointer text-xs sm:text-sm">
  ðŸ”— Generate Link
</button>

<div id="shareLinkModal" class="fixed inset-0 z-50 items-center justify-center hidden" style="background: rgba(0,0,0,0.8);">
  <div class="bg-white rounded-xl p-4 sm:p-6 max-w-md w-full mx-4 shadow-xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-slate-800">Share Your Data</h3>
      <button id="closeModalBtn" class="text-slate-500 hover:text-slate-700">âœ•</button>
    </div>
    <p class="text-sm text-slate-600 mb-4">Share this link with others to show your weight tracker data:</p>
    <div class="flex flex-col gap-4">
      <div class="flex items-center border border-slate-300 rounded-lg overflow-hidden">
        <input 
          type="text" 
          id="shareLink" 
          class="px-3 py-2 w-full text-sm focus:outline-none text-slate-800" 
          readonly
        />
        <button 
          id="copyLinkBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 text-sm font-medium"
        >
          Copy
        </button>
      </div>
      <div id="copyMessage" class="text-green-600 text-sm text-center hidden">
        Link copied to clipboard!
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const generateLinkBtn = document.getElementById("generateLinkBtn");
    const shareLinkModal = document.getElementById("shareLinkModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const shareLinkInput = document.getElementById("shareLink");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const copyMessage = document.getElementById("copyMessage");
    
    if (!generateLinkBtn || !shareLinkModal || !closeModalBtn || !shareLinkInput || !copyLinkBtn || !copyMessage) {
      console.error("Required DOM elements not found");
      return;
    }
    
    generateLinkBtn.addEventListener("click", () => {
      try {
        const weightUnit = localStorage.getItem("weightUnit") || "kg";
        const weightEntries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
        const appData = {
          weightUnit,
          weightEntries,
          version: "1.0",
          timestamp: new Date().toISOString()
        };
        const jsonString = JSON.stringify(appData);
        const textEncoder = new TextEncoder();
        const uint8Array = textEncoder.encode(jsonString);
        const compressed = pako.deflate(uint8Array);
        const base64Compressed = btoa(
          String.fromCharCode.apply(null, compressed)
        ).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        const shareUrl = `${window.location.origin}/share?data=${base64Compressed}`;
        shareLinkInput.value = shareUrl;
        shareLinkModal.classList.remove("hidden");
        shareLinkModal.classList.add("flex");
      } catch (error) {
        console.error("Error generating share link:", error);
        alert("Failed to generate share link. Please try again.");
      }
    });
    copyLinkBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(shareLinkInput.value);
        copyMessage.classList.remove("hidden");
        setTimeout(() => {
          copyMessage.classList.add("hidden");
        }, 2000);
      } catch (error) {
        console.error("Failed to copy link:", error);
        shareLinkInput.select();
        document.execCommand("copy");
        copyMessage.classList.remove("hidden");
        setTimeout(() => {
          copyMessage.classList.add("hidden");
        }, 2000);
      }
    });
    closeModalBtn.addEventListener("click", () => {
      shareLinkModal.classList.add("hidden");
      shareLinkModal.classList.remove("flex");
    });
    shareLinkModal.addEventListener("click", (e) => {
      if (e.target === shareLinkModal) {
        shareLinkModal.classList.add("hidden");
        shareLinkModal.classList.remove("flex");
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !shareLinkModal.classList.contains("hidden")) {
        shareLinkModal.classList.add("hidden");
        shareLinkModal.classList.remove("flex");
      }
    });
  });
</script>