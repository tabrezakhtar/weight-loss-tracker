---
// Graph component - displays weight entries as a line chart using chart.js
---

<div class="w-full bg-white rounded-xl border-2 border-slate-200 p-3 sm:p-4 md:p-6 flex flex-col gap-2 sm:gap-4">
  <h2 class="text-base sm:text-lg md:text-xl font-semibold text-slate-700 flex items-center gap-1 sm:gap-2">üç∞ Weight Trend</h2>
  <div class="w-full flex flex-col items-center">
    <div class="w-full max-w-lg h-[180px] sm:h-[220px] md:h-[250px]">
      <canvas id="weightChart"></canvas>
    </div>
    <div id="no-chart-data" class="text-slate-400 py-2 sm:py-4 text-center text-sm sm:text-base hidden">
      <p>Add weight entries to see your progress chart</p>
    </div>
  </div>
</div>

<script>
  import Chart from "chart.js/auto";
  
  document.addEventListener("DOMContentLoaded", () => {
    const chartCanvas = document.getElementById("weightChart");
    const noDataMessage = document.getElementById("no-chart-data");
    
    if (!chartCanvas || !noDataMessage) {
      console.error("Required DOM elements for chart not found");
      return;
    }
    
    const hexToRgb = (hex) => {
      hex = hex.replace(/^#/, "");
      const bigint = parseInt(hex, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    };
    
    let weightChart = null;
    
    const formatChartDate = (dateString) => {
      const date = new Date(dateString);
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    };
    
    const getCurrentUnit = () => {
      return localStorage.getItem("weightUnit") || "kg";
    };
    
    const generateSineWaveData = () => {
      const points = 10;
      const labels = [];
      const sineData = [];
      const currentUnit = getCurrentUnit();
      const baseWeight = currentUnit === "kg" ? 70 : currentUnit === "lbs" ? 154 : 11;
      const amplitude = currentUnit === "kg" ? 5 : currentUnit === "lbs" ? 11 : 0.7;
      
      for (let i = 0; i < points; i++) {
        const date = new Date();
        date.setDate(date.getDate() - (points - 1 - i) * 7);
        labels.push(formatChartDate(date.toISOString().split("T")[0]));
        
        const sineValue = Math.sin((i / points) * Math.PI * 2) * amplitude + baseWeight;
        sineData.push(Math.round(sineValue * 10) / 10);
      }
      
      return { labels, sineData };
    };

    const prepareChartData = () => {
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      
      if (entries.length === 0) {
        const { labels, sineData } = generateSineWaveData();
        const currentUnit = getCurrentUnit();
        const primaryColor = "#2196F3";
        const primaryColorRGB = hexToRgb(primaryColor.trim()) || { r: 33, g: 150, b: 243 };
        
        return {
          labels,
          datasets: [
            {
              label: `Example Weight (${currentUnit})`,
              data: sineData,
              borderColor: primaryColor,
              backgroundColor: `rgba(${primaryColorRGB.r}, ${primaryColorRGB.g}, ${primaryColorRGB.b}, 0.1)`,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: primaryColor,
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        };
      }
      
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const labels = entries.map(entry => formatChartDate(entry.date));
      const weightData = entries.map(entry => parseFloat(entry.weight));
      
      const currentUnit = getCurrentUnit();
      
      const primaryColor = "#2196F3";
      const primaryColorRGB = hexToRgb(primaryColor.trim()) || { r: 33, g: 150, b: 243 };
      
      return {
        labels,
        datasets: [
          {
            label: `Weight (${currentUnit})`,
            data: weightData,
            borderColor: primaryColor,
            backgroundColor: `rgba(${primaryColorRGB.r}, ${primaryColorRGB.g}, ${primaryColorRGB.b}, 0.1)`,
            tension: 0.3,
            fill: true,
            pointBackgroundColor: primaryColor,
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      };
    };
    
    const updateChart = () => {
      const data = prepareChartData();
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      const isExampleData = entries.length === 0;
      
      noDataMessage.style.display = "none";
      chartCanvas.style.display = "block";
      
      const config = {
        type: "line",
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: `Weight (${getCurrentUnit()})`
              }
            },
            x: {
              title: {
                display: true,
                text: "Date"
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: !isExampleData,
              callbacks: {
                title: (items) => {
                  if (!items.length) return "";
                  const index = items[0].dataIndex;
                  const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
                  if (entries.length <= index) return "";
                  entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                  return new Date(entries[index].date).toLocaleDateString();
                },
                label: (item) => {
                  const currentUnit = getCurrentUnit();
                  return `${item.formattedValue} ${currentUnit}`;
                }
              }
            }
          },
          interaction: {
            mode: isExampleData ? "none" : "index",
            intersect: false
          }
        }
      };
      
      if (weightChart) {
        weightChart.data = data;
        weightChart.update();
      } else {
        weightChart = new Chart(chartCanvas, config);
      }
    };
    
    updateChart();
    
    window.addEventListener("weightEntrySaved", updateChart);
    
    window.addEventListener("weightEntryDeleted", updateChart);
    
    window.addEventListener("weightUnitChanged", (e) => {
      if (weightChart) {
        weightChart.destroy();
        weightChart = null;
      }
      updateChart();
    });
  });
</script>