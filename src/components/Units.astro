---
import Csv from "./Csv.astro";
---

<div class="w-full bg-white rounded-xl border-2 border-slate-200 p-3 sm:p-4 mb-3 sm:mb-6 flex flex-col gap-1 sm:gap-2">
  <h2 class="text-base sm:text-lg font-semibold text-slate-700 flex items-center gap-1 sm:gap-2">⚖️ Weight Unit</h2>
  <div class="flex flex-row items-center justify-between">
    <div class="flex flex-row gap-2 sm:gap-4">
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="weight-unit" value="kg" class="sr-only peer" checked />
        <div class="flex items-center justify-center px-3 sm:px-4 py-1 sm:py-2 rounded-lg transition-all bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white font-medium text-sm sm:text-base">
          kg
        </div>
      </label>
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="weight-unit" value="lbs" class="sr-only peer" />
        <div class="flex items-center justify-center px-3 sm:px-4 py-1 sm:py-2 rounded-lg transition-all bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white font-medium text-sm sm:text-base">
          lbs
        </div>
      </label>
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="weight-unit" value="st" class="sr-only peer" />
        <div class="flex items-center justify-center px-3 sm:px-4 py-1 sm:py-2 rounded-lg transition-all bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white font-medium text-sm sm:text-base">
          stones
        </div>
      </label>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const unitRadios = document.querySelectorAll('input[name="weight-unit"]');
    
    const conversionFactors = {
      kg: { 
        lbs: 2.20462, 
        st: 0.157473 
      },
      lbs: { 
        kg: 0.453592, 
        st: 0.0714286 
      },
      st: { 
        kg: 6.35029, 
        lbs: 14 
      }
    };
    
    const getCurrentUnit = () => {
      return localStorage.getItem("weightUnit") || "kg";
    };
    
    const currentUnit = getCurrentUnit();
    unitRadios.forEach(radio => {
      if (radio.value === currentUnit) {
        radio.checked = true;
      }
    });
    
    const convertWeight = (weight, fromUnit, toUnit) => {
      if (fromUnit === toUnit) return weight;
      
      if (conversionFactors[fromUnit] && conversionFactors[fromUnit][toUnit]) {
        return weight * conversionFactors[fromUnit][toUnit];
      }
      
      if (fromUnit !== "kg" && toUnit !== "kg") {
        const inKg = weight * conversionFactors[fromUnit]["kg"];
        return inKg * conversionFactors["kg"][toUnit];
      }
      
      return weight;
    };
    
    const updateAllWeightEntries = (newUnit) => {
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      const oldUnit = getCurrentUnit();
      
      const updatedEntries = entries.map(entry => {
        const entryUnit = entry.unit || oldUnit;
        const weightInOldUnit = parseFloat(entry.weight);
        
        const weightInNewUnit = convertWeight(weightInOldUnit, entryUnit, newUnit);
        
        return {
          ...entry,
          weight: weightInNewUnit.toFixed(1),
          unit: newUnit
        };
      });
      
      localStorage.setItem("weightUnit", newUnit);
      localStorage.setItem("weightEntries", JSON.stringify(updatedEntries));
      
      const event = new CustomEvent("weightUnitChanged", {
        detail: { oldUnit, newUnit },
        bubbles: true
      });
      window.dispatchEvent(event);
    };
    
    unitRadios.forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.checked) {
          const newUnit = e.target.value;
          updateAllWeightEntries(newUnit);
        }
      });
    });
    
    if (!localStorage.getItem("weightUnit")) {
      localStorage.setItem("weightUnit", "kg");
    }
  });
</script>