---
// WeightList component - displays all weight entries from localStorage
---

<div class="card medium-padding medium-margin-top">
  <h5 class="primary-text">Weight History</h5>
  <p class="small tertiary-text">Edit your weight entries directly and save changes</p>
  <div id="no-entries-message" class="tertiary-text medium-padding" style="display: block;">No weight entries found. Add your first entry above.</div>
  <ul id="weight-entries-list" class="no-padding" style="display: none;"></ul>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const entriesList = document.getElementById("weight-entries-list");
    const noEntriesMessage = document.getElementById("no-entries-message");
    
    if (!entriesList) {
      console.error("Required DOM element not found: weight-entries-list");
      return;
    }
    
    if (!noEntriesMessage) {
      console.error("Required DOM element not found: no-entries-message");
      return;
    }
    
    console.log("WeightList component initialized");
    
    // Function to format a date nicely
    const formatDate = (dateString) => {
      const options = { year: "numeric", month: "short", day: "numeric" };
      return new Date(dateString).toLocaleDateString(undefined, options);
    };
    
    // Function to create an entry list item
    const createEntryElement = (entry) => {
      const listItem = document.createElement("li");
      listItem.dataset.id = entry.id;
      listItem.classList.add("row", "wrap", "bordered", "medium-padding", "middle-align");
      console.log("Created list item for entry:", entry.id);
      
      // Weight value as input field
      const weightContainer = document.createElement("div");
      weightContainer.classList.add("field", "label", "border", "s12", "m6", "l4", "fill-space");
      
      const weightInput = document.createElement("input");
      weightInput.type = "number";
      weightInput.step = "0.1";
      weightInput.min = "0";
      weightInput.value = entry.weight;
      weightInput.setAttribute("aria-label", "Weight value");
      
      const weightLabel = document.createElement("label");
      weightLabel.textContent = "Weight";
      
      weightContainer.appendChild(weightInput);
      weightContainer.appendChild(weightLabel);
      
      // Date as input field
      const dateContainer = document.createElement("div");
      dateContainer.classList.add("field", "label", "border", "s12", "m6", "l4", "fill-space");
      // Responsive classes will be added by adjustResponsiveLayout function
      
      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = entry.date;
      dateInput.setAttribute("aria-label", "Date");
      
      const dateLabel = document.createElement("label");
      dateLabel.textContent = "Date";
      
      dateContainer.appendChild(dateInput);
      dateContainer.appendChild(dateLabel);
      
      // Actions container
      const actionsContainer = document.createElement("div");
      actionsContainer.classList.add("s12", "l4", "row", "small-margin-top");
      
      // Helper function to add conditional margins and sizing
      const adjustResponsiveLayout = () => {
        if (window.innerWidth < 600) {
          // For small screens
          dateContainer.classList.add("full-width");
          dateContainer.classList.add("small-margin-top");
          dateContainer.classList.remove("medium-margin-left");
          
          weightContainer.classList.add("full-width");
          
          actionsContainer.classList.add("full-width");
          actionsContainer.classList.add("center-align");
          actionsContainer.classList.remove("right-align");
        } else {
          // For larger screens
          dateContainer.classList.remove("full-width");
          dateContainer.classList.remove("small-margin-top");
          dateContainer.classList.add("medium-margin-left");
          
          weightContainer.classList.remove("full-width");
          
          actionsContainer.classList.remove("full-width");
          actionsContainer.classList.remove("center-align");
          actionsContainer.classList.add("right-align");
        }
      };
      
      // Apply responsive layout initially and on resize
      adjustResponsiveLayout();
      window.addEventListener("resize", adjustResponsiveLayout);
      
      const saveButton = document.createElement("button");
      saveButton.classList.add("circle", "small", "success", "medium-margin-left");
      saveButton.title = "Save changes";
      saveButton.setAttribute("aria-label", "Save changes");
      const saveIcon = document.createElement("i");
      saveIcon.textContent = "save";
      saveButton.appendChild(saveIcon);
      
      const deleteButton = document.createElement("button");
      deleteButton.classList.add("circle", "small", "error", "medium-margin-left");
      deleteButton.title = "Delete entry";
      deleteButton.setAttribute("aria-label", "Delete entry");
      
      const deleteIcon = document.createElement("i");
      deleteIcon.textContent = "delete";
      deleteButton.appendChild(deleteIcon);
      
      // Add event listeners
      saveButton.addEventListener("click", () => {
        const newWeight = weightInput.value;
        const newDate = dateInput.value;
        
        if (!newWeight || !newDate) {
          alert("Weight and date cannot be empty");
          return;
        }
        
        const hasChanges = 
          newWeight !== entry.weight || 
          newDate !== entry.date;
          
        if (hasChanges) {
          updateEntry(entry.id, {
            weight: newWeight,
            date: newDate
          });
        }
      });
      
      deleteButton.addEventListener("click", () => deleteEntry(entry.id));
      
      // Add real-time saving for inputs
      weightInput.addEventListener("change", () => {
        if (weightInput.value) {
          updateEntry(entry.id, { weight: weightInput.value });
        }
      });
      
      dateInput.addEventListener("change", () => {
        if (dateInput.value) {
          updateEntry(entry.id, { date: dateInput.value });
        }
      });
      
      actionsContainer.appendChild(saveButton);
      actionsContainer.appendChild(deleteButton);
      
      // Add all elements to list item
      listItem.appendChild(weightContainer);
      listItem.appendChild(dateContainer);
      listItem.appendChild(actionsContainer);
      
      return listItem;
    };
    
    // Function to render all entries
    const renderEntries = () => {
      // Clear the current list
      entriesList.innerHTML = "";
      
      // Get all entries from localStorage
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      console.log("Rendering weight entries:", entries);
      
      // Sort entries by date (newest first)
      entries.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Show or hide the no entries message
      if (entries.length === 0) {
        noEntriesMessage.style.display = "block";
        entriesList.style.display = "none";
        console.log("No entries to display");
      } else {
        noEntriesMessage.style.display = "none";
        entriesList.style.display = "block";
        
        // Add each entry to the list
        entries.forEach(entry => {
          console.log("Creating element for entry:", entry);
          const element = createEntryElement(entry);
          entriesList.appendChild(element);
        });
      }
    };
    
    // Function to update an entry - accepts either a single field update or multiple fields
    const updateEntry = (id, updates) => {
      // Get current entries
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      
      // Find and update the specific entry
      const updatedEntries = entries.map(entry => {
        if (entry.id === id) {
          return {
            ...entry,
            ...updates,
            timestamp: new Date().toISOString() // Update timestamp to indicate it was edited
          };
        }
        return entry;
      });
      
      // Save back to localStorage
      localStorage.setItem("weightEntries", JSON.stringify(updatedEntries));
      
      // Re-render the list
      renderEntries();
    };
    
    // Function to delete an entry
    const deleteEntry = (id) => {
      // Get current entries
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      
      // Filter out the entry with the matching ID
      const updatedEntries = entries.filter(entry => entry.id !== id);
      
      // Save back to localStorage
      localStorage.setItem("weightEntries", JSON.stringify(updatedEntries));
      
      // Re-render the list
      renderEntries();
      
      // Dispatch event for the graph to update
      window.dispatchEvent(new CustomEvent("weightEntryDeleted"));
    };
    
    // Listen for the custom event from WeightInput component
    window.addEventListener("weightEntrySaved", (event) => {
      console.log("Weight entry saved event received", event.detail);
      renderEntries();
    });
    
    // Initial render
    renderEntries();
  });
</script>

<style>
  #weight-entries-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  #weight-entries-list li {
    border-radius: 8px;
    margin-bottom: 0.75rem;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
  }
  
  #weight-entries-list li:hover {
    background-color: var(--background-hover);
  }
  
  .full-width {
    width: 100% !important;
    flex-basis: 100% !important;
    max-width: 100% !important;
  }
</style>