---
import Csv from "./Csv.astro";
---

<div class="w-full bg-white rounded-xl border-2 border-slate-200 p-3 sm:p-4 md:p-6 mt-2 sm:mt-4 md:mt-6 flex flex-col gap-2 sm:gap-4">
  <div class="flex flex-row items-center justify-between">
    <h2 class="text-base sm:text-lg md:text-xl font-semibold text-slate-700 flex items-center gap-1 sm:gap-2">ğŸ© Weight History</h2>
    <Csv />
  </div>
  <p class="text-xs sm:text-sm text-slate-500">Edit your weight entries directly and save changes</p>
  <div id="no-entries-message" class="text-slate-400 py-2 sm:py-4 text-center text-xs sm:text-sm">No weight entries found. Add your first entry above.</div>
  <ul id="weight-entries-list" class="flex flex-col gap-2 sm:gap-3 pr-1"></ul>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const entriesList = document.getElementById("weight-entries-list");
    const noEntriesMessage = document.getElementById("no-entries-message");
    if (!entriesList || !noEntriesMessage) return;
    
    window.addEventListener("weightUnitChanged", () => {
      renderEntries();
    });

    const createEntryElement = (entry, isNew = false, index = 0) => {
      const listItem = document.createElement("li");
      listItem.dataset.id = entry.id;
      listItem.className = "flex flex-col sm:flex-row items-center gap-2 bg-stone-50 rounded-lg p-2 sm:p-3 shadow border border-slate-200 transition-all duration-500 ease-out";
      
      if (isNew) {
        listItem.style.opacity = "0";
        listItem.style.transform = "translateY(-20px) scale(0.95)";
      } else {
        listItem.style.opacity = "0";
        listItem.style.transform = "translateY(10px)";
      }

      const weightDiv = document.createElement("div");
      weightDiv.className = "flex flex-col w-full sm:w-1/3";
      const weightLabel = document.createElement("label");
      weightLabel.className = "text-xs text-slate-500 mb-0.5 sm:mb-1";
      weightLabel.textContent = `Weight (${entry.unit || "kg"})`;
      const weightInput = document.createElement("input");
      weightInput.type = "number";
      weightInput.step = "0.1";
      weightInput.min = "0";
      weightInput.value = entry.weight;
      weightInput.className = "input input-bordered w-full px-2 py-1 text-xs sm:text-sm rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white";
      weightDiv.appendChild(weightLabel);
      weightDiv.appendChild(weightInput);

      const dateDiv = document.createElement("div");
      dateDiv.className = "flex flex-col w-full sm:w-1/3";
      const dateLabel = document.createElement("label");
      dateLabel.className = "text-xs text-slate-500 mb-0.5 sm:mb-1";
      dateLabel.textContent = "Date";
      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = entry.date;
      dateInput.className = "input input-bordered w-full px-2 py-1 text-xs sm:text-sm rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white";
      dateDiv.appendChild(dateLabel);
      dateDiv.appendChild(dateInput);

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "flex flex-row sm:flex-col gap-2 w-full sm:w-1/3 justify-center sm:justify-end items-center mt-2 sm:mt-0";
      const saveBtn = document.createElement("button");
      saveBtn.type = "button";
      saveBtn.className = "flex items-center gap-1 bg-green-500 hover:bg-green-600 text-white px-2 sm:px-3 py-1 rounded-lg font-semibold transition-all duration-150 w-16 sm:w-20 text-xs sm:text-sm justify-center";
      saveBtn.title = "Save changes";
      saveBtn.innerHTML = "Save";
      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-2 sm:px-3 py-1 rounded-lg font-semibold transition-all duration-150 w-16 sm:w-20 text-xs sm:text-sm justify-center";
      deleteBtn.title = "Delete entry";
      deleteBtn.innerHTML = "Delete";

      saveBtn.addEventListener("click", () => {
        const newWeight = weightInput.value;
        const newDate = dateInput.value;
        if (!newWeight || !newDate) return;
        if (newWeight !== entry.weight || newDate !== entry.date) {
          updateEntry(entry.id, { weight: newWeight, date: newDate });
        }
      });
      deleteBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to delete this entry?")) {
          deleteEntry(entry.id);
        }
      });
      weightInput.addEventListener("change", () => {
        if (weightInput.value) updateEntry(entry.id, { weight: weightInput.value });
      });
      dateInput.addEventListener("change", () => {
        if (dateInput.value) updateEntry(entry.id, { date: dateInput.value });
      });
      actionsDiv.appendChild(saveBtn);
      actionsDiv.appendChild(deleteBtn);

      listItem.appendChild(weightDiv);
      listItem.appendChild(dateDiv);
      listItem.appendChild(actionsDiv);
      
      if (isNew) {
        setTimeout(() => {
          listItem.style.opacity = "1";
          listItem.style.transform = "translateY(0) scale(1)";
          setTimeout(() => {
            listItem.style.backgroundColor = "rgb(248 250 252)";
          }, 300);
        }, 10);
      } else {
        setTimeout(() => {
          listItem.style.opacity = "1";
          listItem.style.transform = "translateY(0)";
        }, index * 100 + 50);
      }
      
      return listItem;
    };

    const renderEntries = (newEntryId = null) => {
      entriesList.innerHTML = "";
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      entries.sort((a, b) => {
        const timestampA = a.timestamp ? new Date(a.timestamp) : new Date(a.date);
        const timestampB = b.timestamp ? new Date(b.timestamp) : new Date(b.date);
        return timestampB - timestampA;
      });
      if (entries.length === 0) {
        noEntriesMessage.style.display = "block";
        entriesList.style.display = "none";
      } else {
        noEntriesMessage.style.display = "none";
        entriesList.style.display = "flex";
        entries.forEach((entry, index) => {
          const isNew = entry.id === newEntryId;
          entriesList.appendChild(createEntryElement(entry, isNew, index));
        });
      }
    };

    const updateEntry = (id, updates) => {
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      const updatedEntries = entries.map(entry => entry.id === id ? { ...entry, ...updates, timestamp: new Date().toISOString() } : entry);
      localStorage.setItem("weightEntries", JSON.stringify(updatedEntries));
      renderEntries();
    };

    const deleteEntry = (id) => {
      const entries = JSON.parse(localStorage.getItem("weightEntries") || "[]");
      const updatedEntries = entries.filter(entry => entry.id !== id);
      localStorage.setItem("weightEntries", JSON.stringify(updatedEntries));
      renderEntries();
      window.dispatchEvent(new CustomEvent("weightEntryDeleted"));
    };

    window.addEventListener("weightEntrySaved", (event) => {
      const newEntryId = event.detail ? event.detail.id : null;
      renderEntries(newEntryId);
    });
    renderEntries();
  });
</script>

